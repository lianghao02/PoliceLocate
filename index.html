<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <!-- PWA è¨­ç½®ï¼šç¦æ­¢ç¸®æ”¾ï¼Œå…¨è¢å¹•æ¨¡å¼ -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>è­¦ç”¨å®šä½åŠ©æ‰‹</title>

    <!-- å¤–éƒ¨è³‡æºä½¿ç”¨ CDNï¼Œç¢ºä¿è¼‰å…¥é€Ÿåº¦ -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* æ ¸å¿ƒæ¨£å¼ï¼šç°¡æ½”ã€å°ˆæ¥­ã€é˜²èª¤è§¸ */
        :root {
            --primary: #2c3e50;
            --accent: #d35400;
            --bg: #f4f6f7;
            --line: #06c755;
            --tg: #2481cc;
            --copy: #8e44ad;
            --del: #c0392b;
            --white: #ffffff;
            --gray: #e0e0e0;
            --text: #333;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            background: var(--bg);
            color: var(--text);
            padding-bottom: 80px;
            overflow-x: hidden;
            user-select: none;
            /* é˜²æ­¢é•·æŒ‰é¸å–æ–‡å­— */
        }

        /* é˜²æ­¢ iOS æ©¡çš®ç­‹æ•ˆæœ */
        html,
        body {
            height: 100%;
            overscroll-behavior-y: none;
        }

        header {
            background: linear-gradient(135deg, var(--primary), #34495e);
            color: var(--white);
            padding: 20px 15px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        h1 {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 1px;
        }

        small {
            display: block;
            margin-top: 5px;
            opacity: 0.8;
            font-size: 0.8rem;
        }

        .container {
            padding: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: var(--white);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        /* è¼¸å…¥æ§åˆ¶é … */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .input-wrapper {
            flex: 1;
        }

        label {
            display: block;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 6px;
            font-size: 0.9rem;
        }

        input,
        textarea {
            width: 100%;
            border: 2px solid var(--gray);
            border-radius: 10px;
            padding: 12px;
            font-size: 1rem;
            font-family: monospace;
            transition: 0.2s;
            background: #fafafa;
            appearance: none;
            /* ç§»é™¤åŸç”Ÿæ¨£å¼ */
        }

        input:focus,
        textarea:focus {
            border-color: var(--accent);
            background: var(--white);
            outline: none;
        }

        .phone-input {
            border-color: #3498db;
            color: #2980b9;
            font-weight: bold;
        }

        .smart-area {
            height: 100px;
            border-style: dashed;
            border-color: #bdc3c7;
        }

        /* æŒ‰éˆ•ç³»çµ± */
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: var(--white);
            transition: transform 0.1s, opacity 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
            opacity: 0.9;
        }

        .btn-main {
            background: var(--accent);
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(211, 84, 0, 0.2);
        }

        .action-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px dashed #ddd;
        }

        .btn-map {
            background: #4285f4;
        }

        .btn-copy {
            background: var(--copy);
        }

        .btn-tg {
            background: var(--tg);
        }

        .btn-line {
            background: var(--line);
        }

        /* åœ°åœ– */
        #map {
            height: 350px;
            width: 100%;
            border-radius: 16px;
            margin-top: 20px;
            display: none;
            z-index: 1;
        }

        /* æ­·å²ç´€éŒ„ */
        .history-sec {
            margin-top: 30px;
        }

        .hist-head {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 4px solid var(--accent);
        }

        .hist-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
        }

        .btn-clear {
            background: #eee;
            color: #666;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            border: none;
        }

        ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        li {
            background: var(--white);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.03);
            border: 1px solid #eee;
            position: relative;
            user-select: none;
            -webkit-user-select: none;
            /* ç¦æ­¢é¸å–æ–‡å­—ä»¥å…èª¤è§¸ */
        }

        li:active {
            background: #f8f9fa;
            border-color: var(--accent);
        }

        .del-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            color: var(--del);
            padding: 5px;
        }

        .hint {
            text-align: center;
            font-size: 0.85rem;
            color: #888;
            margin-bottom: 10px;
        }

        .tag {
            font-size: 0.8rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: #e3f2fd;
            color: #2980b9;
        }

        /* ç‰ˆæ¬Šæµ®æ°´å° */
        .footer {
            text-align: center;
            margin-top: 30px;
            font-size: 0.75rem;
            color: #bdc3c7;
        }
    </style>
</head>

<body>

    <header>
        <h1>ğŸ‘®â€â™‚ï¸ è­¦ç”¨å®šä½åŠ©æ‰‹</h1>
        <small>PRO v50.0 | æ­£å¼ç™¼å¸ƒç‰ˆ</small>
    </header>

    <div class="container">
        <div class="card">
            <div class="hint"><i class="fa-solid fa-wand-magic-sparkles"></i> è²¼ä¸Šæ•´æ®µæ–‡å­—ï¼Œè‡ªå‹•è¾¨è­˜åº§æ¨™èˆ‡é–€è™Ÿ</div>
            <textarea id="rawInput" class="smart-area" placeholder="é•·æŒ‰è²¼ä¸Š... (æ”¯æ´ LINE/ç°¡è¨Š æ ¼å¼)"></textarea>
            <button class="btn btn-main" onclick="app.parse()">
                <i class="fa-solid fa-bolt"></i> è§£æä¸¦å®šä½
            </button>

            <div class="input-group">
                <div class="input-wrapper">
                    <label><i class="fa-solid fa-mobile-screen"></i> é–€è™Ÿ</label>
                    <input type="tel" id="phone" class="phone-input" placeholder="09xxxxxxxx" readonly
                        onclick="this.removeAttribute('readonly')">
                </div>
            </div>

            <!-- æ–°å¢ï¼šå®šä½è«‹æ±‚æ™‚é–“ -->
            <div class="input-group">
                <div class="input-wrapper">
                    <label><i class="fa-regular fa-clock"></i> å®šä½è«‹æ±‚æ™‚é–“</label>
                    <input type="text" id="reqTime" placeholder="yyyy/MM/dd HH:mm:ss">
                </div>
            </div>

            <!-- æ–°å¢ï¼šè¨»å†ŠåŸºåœ°å°æ™‚é–“ -->
            <div class="input-group">
                <div class="input-wrapper">
                    <label><i class="fa-solid fa-tower-cell"></i> è¨»å†ŠåŸºåœ°å°æ™‚é–“</label>
                    <input type="text" id="regTime" placeholder="yyyy/MM/dd HH:mm:ss">
                </div>
            </div>

            <div class="input-group">
                <div class="input-wrapper">
                    <label>ç·¯åº¦ (Lat)</label>
                    <input type="number" id="lat" step="any" placeholder="23.xxxxx">
                </div>
                <div class="input-wrapper">
                    <label>ç¶“åº¦ (Lng)</label>
                    <input type="number" id="lng" step="any" placeholder="120.xxxxx">
                </div>
            </div>

            <div class="input-group">
                <div class="input-wrapper">
                    <label>æ–¹ä½è§’ <span style="font-weight:normal;color:#999;font-size:0.8rem">(0-360)</span></label>
                    <input type="number" id="azi" placeholder="é¸å¡«">
                </div>
            </div>

            <div class="action-grid">
                <button class="btn btn-map" onclick="app.openMap()"><i class="fa-solid fa-map-location-dot"></i> Google
                    Map</button>
                <button class="btn btn-copy" onclick="app.copy()"><i class="fa-solid fa-copy"></i> è¤‡è£½è³‡è¨Š</button>
                <button class="btn btn-tg" onclick="app.share('tg')"><i class="fa-brands fa-telegram"></i>
                    Telegram</button>
                <button class="btn btn-line" onclick="app.share('line')"><i class="fa-brands fa-line"></i> LINE</button>
            </div>
        </div>

        <div id="map"></div>

        <div class="history-sec">
            <div class="hist-head">
                <div class="hist-title">æœ€è¿‘æŸ¥è©¢</div>
                <button class="btn-clear" onclick="app.clearHistory()"><i class="fa-solid fa-trash-can"></i> æ¸…é™¤</button>
            </div>
            <ul id="list"></ul>
        </div>

        <div class="footer">
            System initialized. Version 50.0 Stable<br>
            &copy; 2025 Police Locate Tool. All rights reserved.
        </div>
    </div>

    <script>
        /**
         * Police Locate Helper v50.0 (Official Release)
         * Encapsulated logic for security and performance.
         */
        const app = (function () {
            // ç§æœ‰è®Šæ•¸
            let map, marker, sector;
            // æ–°å¢ reqTime, regTime æ¬„ä½
            let data = { lat: null, lng: null, azi: null, phone: '', reqTime: '', regTime: '' };
            let history = [];
            const STORAGE_KEY = 'police_locate_v50_db';

            // åˆå§‹åŒ–
            function init() {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) history = JSON.parse(saved);
                renderHistory();

                // ç›£è½è¼¸å…¥æ¡†è®Šæ›´ï¼Œå³æ™‚æ›´æ–°åœ°åœ–ä½†ä¸å­˜æ­·å²
                // åŠ å…¥ reqTime, regTime ç›£è½
                ['lat', 'lng', 'phone', 'azi', 'reqTime', 'regTime'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.addEventListener('change', () => updateFromInput(false));
                });
            }

            // æ ¸å¿ƒè§£æé‚è¼¯
            function parse() {
                const text = document.getElementById('rawInput').value;
                if (!text) return alert('è«‹å…ˆè²¼ä¸Šå…§å®¹ï¼');

                // 1. æŠ“é–€è™Ÿ (09xx æˆ– 8869xx)
                const phMatch = text.match(/(?:[^0-9\.]|^)(09\d{8}|8869\d{8})(?:[^0-9\.]|$)/);
                if (phMatch) {
                    let ph = phMatch[1];
                    if (ph.startsWith('886')) ph = '0' + ph.substring(3);
                    data.phone = ph;
                }

                // 2. æŠ“æ™‚é–“ (å®šä½è«‹æ±‚ & è¨»å†ŠåŸºåœ°å°)
                // æ ¼å¼ï¼šyyyy/MM/dd HH:mm:ss
                // ä½¿ç”¨è¼ƒå¯¬é¬†çš„ regex ä¾†åŒ¹é…æ—¥æœŸæ™‚é–“æ ¼å¼
                const timeRegex = /(\d{4}\/\d{1,2}\/\d{1,2}\s+\d{1,2}:\d{1,2}:\d{1,2})/;

                // å®šä½è«‹æ±‚æ™‚é–“
                const reqMatch = text.match(new RegExp(`(?:å®šä½è«‹æ±‚|Positioning Request)[^:ï¼š\\d]*[:ï¼š]?\\s*${timeRegex.source}`));
                data.reqTime = reqMatch ? reqMatch[1] : '';

                // è¨»å†ŠåŸºåœ°å°æ™‚é–“
                const regMatch = text.match(new RegExp(`(?:è¨»å†ŠåŸºåœ°|Base Station Reg)[^:ï¼š\\d]*[:ï¼š]?\\s*${timeRegex.source}`));
                data.regTime = regMatch ? regMatch[1] : '';

                // 3. æŠ“æ–¹ä½è§’
                const azMatch = text.match(/(?:æ–¹ä½|Dir|Azimuth)[^0-9\n]*([0-9]+(?:\.[0-9]+)?)/i);
                data.azi = azMatch ? parseFloat(azMatch[1]) : null;

                // 4. æŠ“åº§æ¨™ (å„ªåŒ–ç‰ˆï¼šå„ªå…ˆåŒ¹é…æˆå°åº§æ¨™)
                // å°ç£ç¯„åœï¼šLat 21-27, Lng 118-124
                const latPattern = /2[1-7]\.[0-9]+/;
                const lngPattern = /1(?:1[8-9]|2[0-4])\.[0-9]+/;

                // å˜—è©¦æŠ“å–æˆå°çš„åº§æ¨™ (Lat, Lng æˆ– Lng, Lat)ï¼Œä¸­é–“å…è¨±é€—è™Ÿæˆ–ç©ºç™½
                const pairMatch = text.match(/(2[1-7]\.[0-9]+)[^0-9\.]+(1(?:1[8-9]|2[0-4])\.[0-9]+)/) ||
                    text.match(/(1(?:1[8-9]|2[0-4])\.[0-9]+)[^0-9\.]+(2[1-7]\.[0-9]+)/);

                if (pairMatch) {
                    // åˆ¤æ–·å“ªå€‹æ˜¯ Lat å“ªå€‹æ˜¯ Lng
                    const v1 = parseFloat(pairMatch[1]);
                    const v2 = parseFloat(pairMatch[2]);
                    if (v1 < 100) { data.lat = v1; data.lng = v2; }
                    else { data.lng = v1; data.lat = v2; }
                } else {
                    // å‚™ç”¨æ–¹æ¡ˆï¼šå€‹åˆ¥æœå°‹ (è¼ƒå¯¬é¬†ï¼Œä½†ä»éœ€ç¬¦åˆå°ç£ç¯„åœ)
                    const allNums = text.match(/[0-9]+\.[0-9]+/g);
                    if (allNums) {
                        for (let n of allNums) {
                            if (latPattern.test(n)) data.lat = parseFloat(n);
                            if (lngPattern.test(n)) data.lng = parseFloat(n);
                        }
                    }
                }

                if (data.lat && data.lng) {
                    syncUI();
                    updateMap(true); // true = å­˜å…¥æ­·å²
                } else {
                    alert('æ‰¾ä¸åˆ°æœ‰æ•ˆçš„å°ç£åº§æ¨™æ•¸å€¼ï¼Œè«‹ç¢ºèªå…§å®¹ã€‚');
                }
            }

            // å¾è¼¸å…¥æ¡†æ›´æ–°è³‡æ–™
            function updateFromInput(save = false) {
                const lat = parseFloat(document.getElementById('lat').value);
                const lng = parseFloat(document.getElementById('lng').value);
                const az = parseFloat(document.getElementById('azi').value);
                const ph = document.getElementById('phone').value;
                const req = document.getElementById('reqTime').value;
                const reg = document.getElementById('regTime').value;

                if (!isNaN(lat) && !isNaN(lng)) {
                    data = { lat, lng, azi: isNaN(az) ? null : az, phone: ph, reqTime: req, regTime: reg };
                    updateMap(save);
                }
            }

            // æ›´æ–° UI é¡¯ç¤º
            function syncUI() {
                document.getElementById('lat').value = data.lat;
                document.getElementById('lng').value = data.lng;
                document.getElementById('azi').value = data.azi !== null ? data.azi : '';
                document.getElementById('phone').value = data.phone;
                document.getElementById('reqTime').value = data.reqTime;
                document.getElementById('regTime').value = data.regTime;
            }

            // æ›´æ–°åœ°åœ–èˆ‡æ­·å²
            function updateMap(save) {
                const mapDiv = document.getElementById('map');
                mapDiv.style.display = 'block';

                if (!map) {
                    map = L.map('map').setView([data.lat, data.lng], 16);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
                } else {
                    map.setView([data.lat, data.lng], 16);
                    map.invalidateSize();
                }

                if (marker) map.removeLayer(marker);
                if (sector) map.removeLayer(sector);

                // åœ°åœ– Popup é¡¯ç¤ºå…§å®¹
                let desc = `<b>ğŸ“ å®šä½é»</b><br>${data.lat}, ${data.lng}`;
                if (data.phone) desc += `<br>ğŸ“ ${data.phone}`;
                if (data.reqTime) desc += `<br>ğŸ•’ è«‹æ±‚: ${data.reqTime}`;
                if (data.regTime) desc += `<br>ğŸ“¡ è¨»å†Š: ${data.regTime}`;
                if (data.azi !== null) desc += `<br>ğŸ§­ æ–¹ä½: ${data.azi}Â°`;

                marker = L.marker([data.lat, data.lng]).addTo(map).bindPopup(desc).openPopup();

                if (data.azi !== null) {
                    drawSector(data.lat, data.lng, data.azi);
                } else {
                    sector = L.circle([data.lat, data.lng], { radius: 300, color: '#3498db', fillOpacity: 0.2 }).addTo(map);
                }

                if (save) addHistory();
                mapDiv.scrollIntoView({ behavior: 'smooth' });
            }

            function drawSector(lat, lng, deg) {
                const r = 500, spread = 60;
                const start = (90 - (deg - spread / 2)) * (Math.PI / 180);
                const end = (90 - (deg + spread / 2)) * (Math.PI / 180);
                let pts = [[lat, lng]];
                for (let i = 0; i <= 15; i++) {
                    let a = start - (i / 15) * (start - end);
                    let dLat = (r / 111000) * Math.sin(a);
                    let dLng = (r / (111000 * Math.cos(lat * Math.PI / 180))) * Math.cos(a);
                    pts.push([lat + dLat, lng + dLng]);
                }
                pts.push([lat, lng]);
                sector = L.polygon(pts, { color: '#d35400', fillColor: '#e67e22', fillOpacity: 0.4, weight: 2 }).addTo(map);
            }

            // åŠŸèƒ½æŒ‰éˆ•
            function openMap() {
                if (!data.lat) return alert('ç„¡åº§æ¨™');
                window.open(`https://www.google.com/maps?q=${data.lat},${data.lng}`, '_blank');
            }

            function copy() {
                if (!data.lat) return alert('ç„¡åº§æ¨™');
                let t = `æ™‚é–“: ${new Date().toLocaleString()}\n`;
                if (data.phone) t += `é–€è™Ÿ: ${data.phone}\n`;
                if (data.reqTime) t += `è«‹æ±‚æ™‚é–“: ${data.reqTime}\n`;
                if (data.regTime) t += `è¨»å†Šæ™‚é–“: ${data.regTime}\n`;
                t += `åº§æ¨™: ${data.lat}, ${data.lng}`;
                if (data.azi) t += ` (æ–¹ä½:${data.azi})`;
                t += `\nhttps://www.google.com/maps?q=${data.lat},${data.lng}`;

                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(t).then(() => alert('âœ… å·²è¤‡è£½'));
                } else {
                    const ta = document.createElement('textarea'); ta.value = t;
                    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
                    document.body.removeChild(ta); alert('âœ… å·²è¤‡è£½');
                }
            }

            function share(type) {
                if (!data.lat) return alert('ç„¡åº§æ¨™');
                let t = `ğŸš¨ å®šä½: ${data.lat}, ${data.lng}`;
                if (data.phone) t += ` (${data.phone})`;
                const url = `https://maps.google.com/?q=${data.lat},${data.lng}`;

                if (type === 'line') {
                    t += `\n${url}`;
                    window.open(`https://line.me/R/msg/text/?${encodeURIComponent(t)}`, '_blank');
                } else {
                    window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(t)}`, '_blank');
                }
            }

            // æ­·å²ç´€éŒ„ç®¡ç†
            function addHistory() {
                if (history.length > 0) {
                    const last = history[0];
                    if (last.lat === data.lat && last.lng === data.lng && last.phone === data.phone && last.reqTime === data.reqTime) return;
                }
                history.unshift({
                    id: Date.now(),
                    time: new Date().toLocaleString('zh-TW', { hour12: false }),
                    ...data
                });
                if (history.length > 50) history.pop();
                saveHistory();
            }

            function deleteItem(id, e) {
                e.stopPropagation();
                history = history.filter(x => x.id !== id);
                saveHistory();
            }

            function clearHistory() {
                if (confirm('ç¢ºå®šæ¸…ç©ºç´€éŒ„ï¼Ÿ')) { history = []; saveHistory(); }
            }

            function saveHistory() {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(history));
                renderHistory();
            }

            function renderHistory() {
                const ul = document.getElementById('list'); ul.innerHTML = '';
                if (!history.length) { ul.innerHTML = '<li style="text-align:center;padding:20px;color:#aaa;">æš«ç„¡ç´€éŒ„</li>'; return; }

                history.forEach(item => {
                    const li = document.createElement('li');
                    li.innerHTML = `
                <div style="font-size:0.8rem;color:#999;margin-bottom:4px;">${item.time}</div>
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                    <span style="font-weight:700;color:#2c3e50;font-size:1.05rem;">${item.lat}, ${item.lng}</span>
                    ${item.phone ? `<span class="tag">${item.phone}</span>` : ''}
                </div>
                ${item.reqTime ? `<div style="font-size:0.85rem;color:#555;">ğŸ•’ ${item.reqTime}</div>` : ''}
                ${item.azi ? `<div style="font-size:0.85rem;color:#d35400;">ğŸ§­ æ–¹ä½: ${item.azi}Â°</div>` : ''}
                <i class="fa-solid fa-xmark del-icon" onclick="app.deleteItem(${item.id}, event)"></i>
            `;
                    li.onclick = () => {
                        data = { lat: item.lat, lng: item.lng, azi: item.azi, phone: item.phone, reqTime: item.reqTime, regTime: item.regTime };
                        syncUI(); updateMap(false);
                    };
                    ul.appendChild(li);
                });
            }

            // å…¬é–‹ä»‹é¢ (Public API)
            return {
                init, // æ˜ç¢ºæš´éœ² init
                parse, updateMap, openMap, copy, share,
                clearHistory, deleteItem
            };
        })();

        // å•Ÿå‹•
        window.onload = app.init;
    </script>

</body>

</html>