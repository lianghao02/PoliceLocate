<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è­¦ç”¨å®šä½åŠ©æ‰‹ (v11 ç¾åŒ–ç‰ˆ)</title>
    
    <!-- å¼•å…¥ Google Fonts: Noto Sans TC -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Leaflet åœ°åœ– -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Tesseract.js (OCR) -->
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>

    <!-- Cropper.js (åœ–ç‰‡è£åˆ‡) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;    /* æ²‰ç©©æ·±è— */
            --accent-color: #3498db;     /* äº®çœ¼è— */
            --success-color: #27ae60;    /* æˆåŠŸç¶  */
            --warning-color: #f39c12;    /* è­¦å‘Šé»ƒ */
            --bg-color: #ecf0f1;         /* æŸ”å’Œç°åº• */
            --card-bg: #ffffff;
            --text-main: #2c3e50;
            --text-sub: #7f8c8d;
            --line-color: #06c755;       /* LINE å“ç‰Œè‰² */
        }

        body {
            font-family: 'Noto Sans TC', -apple-system, BlinkMacSystemFont, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            overscroll-behavior: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* é ‚éƒ¨æ¨™é¡Œåˆ— */
        header {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        header h1 { margin: 0; font-size: 1.4rem; font-weight: 700; letter-spacing: 1px; }
        header small { display: block; margin-top: 5px; opacity: 0.9; font-size: 0.85rem; font-weight: 400; }

        .container {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 100px;
        }

        /* é€šç”¨å¡ç‰‡æ¨£å¼ */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.05);
            border: 1px solid rgba(0,0,0,0.02);
            transition: transform 0.2s ease;
        }

        /* æ‹–æ›³å€å¡Šç¾åŒ– */
        .drop-zone {
            border: 2px dashed #bdc3c7;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            position: relative;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }
        .drop-zone:hover, .drop-zone.dragover {
            background: #ebf5fb;
            border-color: var(--accent-color);
            transform: translateY(-2px);
        }
        .drop-zone input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .icon-upload { font-size: 48px; margin-bottom: 10px; display: block; }
        .drop-text-main { font-size: 1.1rem; font-weight: 500; color: var(--primary-color); }
        .drop-text-sub { font-size: 0.9rem; color: var(--text-sub); margin-top: 5px; }

        /* æ¿¾é¡é¸é …å€ */
        .filter-options {
            margin-top: 20px;
            padding: 15px;
            background: #f7f9f9;
            border-radius: 10px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            font-size: 0.95rem;
            border-left: 4px solid var(--text-sub);
        }
        .filter-options input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
        }
        .filter-label strong { color: var(--primary-color); display: block; margin-bottom: 3px;}
        .filter-label span { font-size: 0.85rem; color: var(--text-sub); }

        /* é è¦½èˆ‡æ–‡å­—æ¡† */
        #debug-preview {
            display: none;
            margin-top: 20px;
            text-align: center;
            background: #2c3e50;
            padding: 10px;
            border-radius: 8px;
        }
        #debug-preview img { max-height: 120px; border: 1px solid #fff; max-width: 100%; }
        .preview-label { color: #fff; font-size: 0.8rem; margin-bottom: 8px; display: block; }

        textarea {
            width: 100%;
            height: 110px;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
            padding: 15px;
            font-size: 16px;
            margin-top: 20px;
            font-family: 'Monaco', 'Consolas', monospace;
            box-sizing: border-box;
            transition: border-color 0.2s;
            background: #fafafa;
        }
        textarea:focus { outline: none; border-color: var(--accent-color); background: #fff; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        button {
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        button:active { transform: scale(0.98); }
        
        .btn-action { background: var(--primary-color); color: white; box-shadow: 0 4px 10px rgba(44, 62, 80, 0.2); }
        .btn-action:hover { background: #34495e; box-shadow: 0 6px 15px rgba(44, 62, 80, 0.3); }
        
        .btn-clear { background: #e0e0e0; color: #555; }
        .btn-clear:hover { background: #d5d5d5; }

        .duty-actions {
            display: none; /* è§£ææˆåŠŸå¾Œé¡¯ç¤º */
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px dashed #eee;
        }
        .btn-line { background: var(--line-green); color: white; box-shadow: 0 4px 10px rgba(6, 199, 85, 0.2); }
        .btn-line:hover { background: #05b34c; }
        .btn-gmap { background: #4285f4; color: white; box-shadow: 0 4px 10px rgba(66, 133, 244, 0.2); }
        .btn-gmap:hover { background: #3367d6; }

        /* æ­·å²ç´€éŒ„ */
        .history-section { margin-top: 30px; }
        .history-title { 
            font-size: 1.2rem; 
            font-weight: 700; 
            color: var(--primary-color); 
            margin-bottom: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding-left: 10px;
            border-left: 5px solid var(--accent-color);
        }
        .history-list { list-style: none; padding: 0; margin: 0; }
        .history-item {
            background: white;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
            position: relative;
            border: 1px solid #eee;
            transition: transform 0.2s;
        }
        .history-item:hover { transform: translateX(3px); border-color: var(--accent-color); }
        .history-time { font-size: 0.85rem; color: #95a5a6; margin-bottom: 5px; }
        .history-coord { font-weight: 700; font-size: 1.1rem; color: var(--primary-color); font-family: monospace; }
        .history-meta { font-size: 0.9rem; color: #666; margin-top: 5px; background: #f4f6f7; display: inline-block; padding: 3px 8px; border-radius: 4px;}
        .history-actions { margin-top: 12px; display: flex; gap: 10px; }
        
        .btn-sm { padding: 8px 16px; font-size: 0.9rem; border-radius: 6px; }
        .btn-del { 
            background: transparent; 
            color: #e74c3c; 
            position: absolute; 
            top: 15px; 
            right: 15px; 
            padding: 5px;
            font-size: 0.9rem;
            box-shadow: none;
        }
        .btn-del:hover { background: #fee; }

        #map { height: 400px; width: 100%; border-radius: 12px; margin-top: 20px; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        
        #status-bar { 
            display: none; 
            padding: 12px; 
            background: #d4edda; 
            color: #155724; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            text-align: center; 
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        /* è£åˆ‡è¦–çª—å„ªåŒ– */
        #cropModal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.92); z-index: 9999; flex-direction: column; }
        .crop-hint-bar {
            background: rgba(243, 156, 18, 0.9);
            color: #fff;
            padding: 12px;
            text-align: center;
            font-weight: 500;
            font-size: 1rem;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 10001;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .crop-container { flex: 1; overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; padding: 40px 20px 80px 20px; }
        .crop-controls { 
            height: 80px; 
            background: #1e272e; 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            padding: 10px; 
            align-items: center; 
            position: absolute;
            bottom: 0;
            width: 100%;
            z-index: 10001;
        }
        #imageToCrop { max-width: 100%; max-height: 100%; }
        .btn-crop-confirm { background: var(--success-color); color: white; width: 160px; font-size: 1.1rem; }
        .btn-crop-cancel { background: #555; color: white; width: 100px; }
    </style>
</head>
<body>

<header>
    <h1>ğŸ‘®â€â™‚ï¸ è­¦å¯Ÿå°å¹«æ‰‹ v11</h1>
    <small>å‹¤å‹™æ•´åˆç³»çµ± | æ­·å²ç´€éŒ„ | LINE é€šå ±</small>
</header>

<div class="container">
    <div id="status-bar">ç³»çµ±æº–å‚™å°±ç·’</div>

    <div class="card">
        <!-- æ‹–æ›³å€ -->
        <div class="drop-zone" id="dropZone">
            <span class="icon-upload">ğŸ“·</span>
            <div class="drop-text-main">é»æ“Šæˆ–æ‹–æ›³åœ–ç‰‡è‡³æ­¤</div>
            <div class="drop-text-sub">æ”¯æ´æ‰‹æ©Ÿæˆªåœ–ã€ç¿»æ‹è¢å¹•ç…§ç‰‡</div>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(this)">
        </div>

        <!-- æ¿¾é¡é¸é … -->
        <div class="filter-options">
            <input type="checkbox" id="useHighContrast">
            <div class="filter-label">
                <strong>é–‹å•Ÿå¼·æ•ˆæ¿¾é¡ (é»‘ç™½äºŒå€¼åŒ–)</strong>
                <span>â€» é©ç”¨æ–¼ç´™æœ¬æ–‡ä»¶æˆ–å¢¨è·¡è¼ƒæ·¡çš„åœ–ç‰‡ã€‚è‹¥ç‚ºç¿»æ‹è¢å¹•è«‹<b>é—œé–‰</b>ä»¥é¿å…æ‘©çˆ¾ç´‹å¹²æ“¾ã€‚</span>
            </div>
        </div>

        <!-- é è¦½ -->
        <div id="debug-preview">
            <span class="preview-label">â–¼ æ©Ÿå™¨è®€å–çš„å½±åƒ (ç”¨æ–¼é™¤éŒ¯)</span>
            <img id="processedImg" src="" />
        </div>
        
        <textarea id="inputText" placeholder="ç­‰å¾…åœ–ç‰‡è§£æ... 
OCR çµæœå°‡é¡¯ç¤ºæ–¼æ­¤ï¼Œäº¦å¯æ‰‹å‹•è¼¸å…¥åº§æ¨™ã€‚"></textarea>
        
        <div class="btn-group">
            <button class="btn-clear" onclick="resetAll()">ğŸ”„ æ¸…ç©ºé‡ä¾†</button>
            <button class="btn-action" onclick="parseText()">ğŸ” é–‹å§‹è§£æ</button>
        </div>

        <!-- å‹¤å‹™æŒ‰éˆ• -->
        <div class="duty-actions" id="dutyActions">
            <button class="btn-gmap" onclick="openGoogleMaps()">ğŸŒ Google åœ°åœ–</button>
            <button class="btn-line" onclick="shareToLine()">ğŸ’¬ å‚³é€ LINE</button>
        </div>
    </div>

    <div id="map"></div>

    <div class="history-section">
        <div class="history-title">
            <span>ğŸ“ æ­·å²ç´€éŒ„ (æœ¬æ©Ÿ)</span>
            <button class="btn-sm btn-clear" onclick="clearHistory()" style="width: auto; padding: 5px 10px;">ğŸ—‘ï¸ å…¨éƒ¨æ¸…é™¤</button>
        </div>
        <ul class="history-list" id="historyList"></ul>
    </div>
</div>

<!-- è£åˆ‡è¦–çª— -->
<div id="cropModal">
    <!-- é ‚éƒ¨æç¤ºæ¢ -->
    <div class="crop-hint-bar">
        ğŸ’¡ è¨£ç«…ï¼šè«‹ç›¡é‡åªæ¡†é¸ã€Œç¶“ç·¯åº¦æ•¸å­—ã€ï¼Œé¿é–‹ä¸­æ–‡èˆ‡é›œè¨Šï¼
    </div>
    <div class="crop-container">
        <img id="imageToCrop" src="" alt="Source Image">
    </div>
    <div class="crop-controls">
        <button class="btn-crop-cancel" onclick="closeCropModal()">å–æ¶ˆ</button>
        <button class="btn-crop-confirm" onclick="confirmCrop()">âœ‚ï¸ ç¢ºèªè£åˆ‡</button>
    </div>
</div>

<script>
    let map, marker, sectorLayer;
    let cropper;
    let currentLat = null, currentLng = null;
    let historyData = [];

    window.onload = function() {
        loadHistory();
    };

    // --- 1. æª”æ¡ˆè™•ç† ---
    const dropZone = document.getElementById('dropZone');
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, e => { e.preventDefault(); e.stopPropagation(); }, false));
    ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('dragover'), false));
    ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('dragover'), false));
    dropZone.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        if (files.length) processFile(files[0]);
    }, false);

    function handleFileSelect(input) {
        if (input.files.length) processFile(input.files[0]);
        input.value = '';
    }
    function processFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => openCropModal(e.target.result);
        reader.readAsDataURL(file);
    }

    // --- 2. è£åˆ‡èˆ‡å½±åƒè™•ç† ---
    function openCropModal(src) {
        const modal = document.getElementById('cropModal');
        const img = document.getElementById('imageToCrop');
        img.src = src;
        modal.style.display = 'flex';
        if (cropper) cropper.destroy();
        setTimeout(() => {
            cropper = new Cropper(img, {
                viewMode: 1, dragMode: 'move', autoCropArea: 0.6,
                restore: false, guides: true, center: true, highlight: false,
                cropBoxMovable: true, cropBoxResizable: true, toggleDragModeOnDblclick: false,
            });
        }, 100);
    }
    function closeCropModal() {
        document.getElementById('cropModal').style.display = 'none';
        if (cropper) cropper.destroy();
    }
    function confirmCrop() {
        if (!cropper) return;
        let canvas = cropper.getCroppedCanvas();
        closeCropModal();
        
        // æ™ºæ…§æ”¾å¤§ (ä¿æŒ v10 çš„ 800px é‚è¼¯)
        if (canvas.width < 800) {
            const scale = 800 / canvas.width;
            const newC = document.createElement('canvas');
            newC.width = 800;
            newC.height = canvas.height * scale;
            const ctx = newC.getContext('2d');
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(canvas, 0, 0, newC.width, newC.height);
            canvas = newC;
        }

        const useHighContrast = document.getElementById('useHighContrast').checked;
        preprocessImage(canvas, useHighContrast);
        
        document.getElementById('debug-preview').style.display = 'block';
        document.getElementById('processedImg').src = canvas.toDataURL();
        
        runOCR(canvas);
    }

    function preprocessImage(canvas, highContrast) {
        const ctx = canvas.getContext('2d');
        let idata = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let d = idata.data;
        
        // 1. ç°éšèˆ‡å°æ¯”åº¦èª¿æ•´
        for (let i = 0; i < d.length; i += 4) {
            const avg = (0.299 * d[i] + 0.587 * d[i+1] + 0.114 * d[i+2]);
            if (highContrast) {
                const c = avg < 160 ? 0 : 255;
                d[i] = d[i+1] = d[i+2] = c;
            } else {
                let c = avg;
                c = (c - 50) * 1.2; 
                if (c < 0) c = 0;
                if (c > 255) c = 255;
                d[i] = d[i+1] = d[i+2] = c;
            }
        }
        ctx.putImageData(idata, 0, 0);

        // 2. å½±åƒéŠ³åŒ– (Sharpening) - æ–°å¢åŠŸèƒ½
        // ä½¿ç”¨å·ç©æ¿¾é¡ä¾†å¢å¼·é‚Šç·£
        if (!highContrast) { // å¦‚æœå·²ç¶“æ˜¯é«˜å°æ¯”äºŒå€¼åŒ–ï¼Œé€šå¸¸ä¸éœ€è¦å†éŠ³åŒ–
            const sharpenKernel = [
                0, -1,  0,
                -1,  5, -1,
                0, -1,  0
            ];
            idata = convolution(ctx, idata, sharpenKernel);
            ctx.putImageData(idata, 0, 0);
        }
    }

    // å·ç©é‹ç®—å‡½å¼ (ç”¨æ–¼å½±åƒè™•ç†)
    function convolution(ctx, idata, kernel) {
        const side = Math.round(Math.sqrt(kernel.length));
        const halfSide = Math.floor(side / 2);
        const src = idata.data;
        const w = idata.width;
        const h = idata.height;
        const output = ctx.createImageData(w, h);
        const dst = output.data;

        for (let y = 0; y < h; y++) {
            for (let x = 0; x < w; x++) {
                const dstOff = (y * w + x) * 4;
                let r = 0, g = 0, b = 0;
                for (let cy = 0; cy < side; cy++) {
                    for (let cx = 0; cx < side; cx++) {
                        const scy = y + cy - halfSide;
                        const scx = x + cx - halfSide;
                        if (scy >= 0 && scy < h && scx >= 0 && scx < w) {
                            const srcOff = (scy * w + scx) * 4;
                            const wt = kernel[cy * side + cx];
                            r += src[srcOff] * wt;
                            g += src[srcOff + 1] * wt;
                            b += src[srcOff + 2] * wt;
                        }
                    }
                }
                dst[dstOff] = r;
                dst[dstOff + 1] = g;
                dst[dstOff + 2] = b;
                dst[dstOff + 3] = 255; // Alpha
            }
        }
        return output;
    }

    // --- 3. OCR è¾¨è­˜ ---
    function runOCR(canvas) {
        const bar = document.getElementById('status-bar');
        bar.style.display = 'block';
        bar.innerText = 'â³ æ­£åœ¨è¾¨è­˜ä¸­...';
        bar.style.background = '#d6eaf8';
        bar.style.color = '#2980b9';
        
        Tesseract.recognize(canvas, 'eng+chi_tra').then(({ data: { text } }) => {
            bar.innerText = 'âœ… è¾¨è­˜å®Œæˆï¼Œè§£æä¸­...';
            bar.style.background = '#d4edda';
            bar.style.color = '#155724';
            
            let clean = text.replace(/O/g, '0').replace(/o/g, '0')
                            .replace(/l/g, '1').replace(/I/g, '1')
                            .replace(/S/g, '5').replace(/B/g, '8')
                            .replace(/\|/g, '1');
            document.getElementById('inputText').value = clean;
            parseText();
        }).catch(err => {
            console.error(err);
            bar.innerText = 'âŒ è¾¨è­˜å¤±æ•—ï¼Œè«‹é‡è©¦';
            bar.style.background = '#f8d7da';
            bar.style.color = '#721c24';
        });
    }

    // --- 4. è§£æé‚è¼¯ (v7 æ ¸å¿ƒ) ---
    function parseText() {
        const text = document.getElementById('inputText').value;
        const bar = document.getElementById('status-bar');
        
        currentLat = null;
        currentLng = null;

        const tokens = text.match(/[0-9]+(?:\.[0-9]+)?/g);
        let latList = [], lngList = [];

        if (tokens) {
            for (let i = 0; i < tokens.length; i++) {
                checkCandidate(tokens[i], latList, lngList);
                if (i < tokens.length - 1) {
                    checkCandidate(tokens[i] + "." + tokens[i+1], latList, lngList);
                }
            }
        }

        if (latList.length) currentLat = latList.sort((a,b) => b.toString().length - a.toString().length)[0];
        if (lngList.length) currentLng = lngList.sort((a,b) => b.toString().length - a.toString().length)[0];

        const dirM = text.match(/(?:æ–¹å‘è§’|Dir|AntennaDir|Azimuth)[^0-9\n]*([0-9]+(?:\.[0-9]+)?)/i);
        const cellM = text.match(/(?:CellID|CID|åŸºç«™|ç·¨è™Ÿ)[^0-9\n]*([0-9]+)/i);
        
        let dir = dirM ? parseFloat(dirM[1]) : null;
        let cellId = cellM ? cellM[1] : null;

        if (currentLat && currentLng) {
            bar.innerText = `âœ… å®šä½æˆåŠŸ: ${currentLat}, ${currentLng}`;
            bar.style.background = '#d4edda';
            bar.style.color = '#155724';
            showMap(currentLat, currentLng, dir, cellId);
            document.getElementById('dutyActions').style.display = 'grid';
            addToHistory(currentLat, currentLng, cellId, dir);
        } else {
            bar.innerText = 'âš ï¸ è§£æå¤±æ•—ï¼Œè«‹æ‰‹å‹•ä¿®æ­£æ–‡å­—æ¡†å…§çš„æ•¸å­—';
            bar.style.background = '#fff3cd';
            bar.style.color = '#856404';
        }
    }

    function checkCandidate(str, latList, lngList) {
        let raw = parseFloat(str.replace(/\./g, ""));
        if (isNaN(raw)) return;
        
        let lat = tryFit(raw, 21, 27);
        if (!lat && parseFloat(str) >= 21 && parseFloat(str) <= 27) lat = parseFloat(str);
        if (lat) latList.push(lat);

        let lng = tryFit(raw, 118, 124);
        if (!lng && parseFloat(str) >= 118 && parseFloat(str) <= 124) lng = parseFloat(str);
        if (lng) lngList.push(lng);
    }

    function tryFit(num, min, max) {
        let t = num;
        if (t >= min && t <= max) return t;
        while (t > max) t /= 10;
        if (t >= min) return t;
        return null;
    }

    // --- 5. åœ°åœ–é¡¯ç¤º ---
    function showMap(lat, lng, dir, cellId) {
        const mapDiv = document.getElementById('map');
        mapDiv.style.display = 'block';
        
        if (!map) {
            map = L.map('map').setView([lat, lng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);
        } else {
            map.setView([lat, lng], 16);
            map.invalidateSize();
        }

        if (marker) map.removeLayer(marker);
        if (sectorLayer) map.removeLayer(sectorLayer);

        let popMsg = `<b>ğŸ¯ å®šä½é»</b><br>Lat: ${lat}<br>Lng: ${lng}`;
        if (cellId) popMsg += `<br>CID: ${cellId}`;
        
        marker = L.marker([lat, lng]).addTo(map).bindPopup(popMsg).openPopup();

        if (dir !== null) {
            drawSector(lat, lng, dir);
        } else {
            sectorLayer = L.circle([lat, lng], { radius: 300, color: '#3498db', fillOpacity: 0.2 }).addTo(map);
        }
        
        // æ»¾å‹•åˆ°åœ°åœ–
        mapDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function drawSector(lat, lng, angle) {
        const r = 500;
        const spread = 60;
        const start = (90 - (angle - spread/2)) * (Math.PI/180);
        const end = (90 - (angle + spread/2)) * (Math.PI/180);
        let pts = [[lat, lng]];
        for(let i=0; i<=15; i++) {
            let a = start - (i/15)*(start-end);
            let dLat = (r/111000) * Math.sin(a);
            let dLng = (r/(111000*Math.cos(lat*Math.PI/180))) * Math.cos(a);
            pts.push([lat+dLat, lng+dLng]);
        }
        pts.push([lat, lng]);
        sectorLayer = L.polygon(pts, { color:'red', fillColor:'#e74c3c', fillOpacity:0.4, weight:1 }).addTo(map);
    }

    function openGoogleMaps() {
        if (currentLat && currentLng) window.open(`https://www.google.com/maps/search/?api=1&query=${currentLat},${currentLng}`, '_blank');
    }

    function shareToLine() {
        if (!currentLat || !currentLng) return;
        const date = new Date().toLocaleString('zh-TW', { hour12: false });
        const mapUrl = `https://www.google.com/maps/search/?api=1&query=${currentLat},${currentLng}`;
        let text = `ğŸš¨ [è­¦ç”¨å®šä½é€šå ±]\næ™‚é–“: ${date}\nåº§æ¨™: ${currentLat}, ${currentLng}\nåœ°åœ–é€£çµ: ${mapUrl}`;
        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`, '_blank');
    }

    // --- 7. æ­·å²ç´€éŒ„ ---
    function loadHistory() {
        const stored = localStorage.getItem('police_locate_history');
        if (stored) {
            historyData = JSON.parse(stored);
        }
        renderHistory();
    }

    function addToHistory(lat, lng, cellId, dir) {
        if (historyData.length > 0 && historyData[0].lat === lat && historyData[0].lng === lng) return;
        const newItem = {
            id: Date.now(),
            time: new Date().toLocaleString('zh-TW', { hour12: false }),
            lat: lat, lng: lng,
            cellId: cellId || 'ç„¡', dir: dir || 'ç„¡'
        };
        historyData.unshift(newItem);
        if (historyData.length > 20) historyData.pop();
        localStorage.setItem('police_locate_history', JSON.stringify(historyData));
        renderHistory();
    }

    function renderHistory() {
        const list = document.getElementById('historyList');
        list.innerHTML = '';
        if (historyData.length === 0) {
            list.innerHTML = '<li style="text-align:center; padding:30px; color:#bdc3c7; font-weight:500;">ç›®å‰æ²’æœ‰æ­·å²ç´€éŒ„</li>';
            return;
        }
        historyData.forEach(item => {
            const li = document.createElement('li');
            li.className = 'history-item';
            li.innerHTML = `
                <button class="btn-del" onclick="deleteHistory(${item.id})">âœ• åˆªé™¤</button>
                <div class="history-time">${item.time}</div>
                <div class="history-coord">${item.lat}, ${item.lng}</div>
                <div class="history-meta">
                    <span>ğŸ“¡ CID: ${item.cellId}</span> | <span>ğŸ§­ Dir: ${item.dir}Â°</span>
                </div>
                <div class="history-actions">
                    <button class="btn-sm btn-line" onclick="shareHistoryItem(${item.lat}, ${item.lng})">ğŸ’¬ LINE</button>
                    <button class="btn-sm btn-gmap" onclick="openHistoryMap(${item.lat}, ${item.lng})">ğŸŒ åœ°åœ–</button>
                </div>
            `;
            list.appendChild(li);
        });
    }

    function deleteHistory(id) {
        historyData = historyData.filter(item => item.id !== id);
        localStorage.setItem('police_locate_history', JSON.stringify(historyData));
        renderHistory();
    }

    function clearHistory() {
        if(confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ­·å²ç´€éŒ„å—ï¼Ÿ")) {
            historyData = [];
            localStorage.removeItem('police_locate_history');
            renderHistory();
        }
    }

    function openHistoryMap(lat, lng) {
        window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lng}`, '_blank');
    }
    function shareHistoryItem(lat, lng) {
        const mapUrl = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
        let text = `ğŸš¨ [æ­·å²å®šä½è½‰å‚³]\nåº§æ¨™: ${lat}, ${lng}\nåœ°åœ–: ${mapUrl}`;
        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`, '_blank');
    }

    function resetAll() {
        document.getElementById('inputText').value = '';
        document.getElementById('debug-preview').style.display = 'none';
        document.getElementById('dutyActions').style.display = 'none';
        document.getElementById('fileInput').value = '';
        document.getElementById('status-bar').style.display = 'none';
        if (marker) map.removeLayer(marker);
        if (sectorLayer) map.removeLayer(sectorLayer);
        document.getElementById('map').style.display = 'none';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
</script>

</body>
</html>