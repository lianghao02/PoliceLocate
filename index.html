<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è­¦ç”¨å®šä½åŠ©æ‰‹ (v16 çµ‚æ¥µä¿®å¾©ç‰ˆ)</title>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/tesseract.js@v2.1.0/dist/tesseract.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --accent-color: #e67e22; /* æ”¹ç‚ºæ´»æ½‘çš„æ©˜è‰²å¼·èª¿æ“ä½œ */
            --success-color: #27ae60;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --line-color: #06c755;
            --tg-color: #2481cc; 
            --copy-color: #8e44ad; 
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: #333;
            overscroll-behavior: none;
        }

        header {
            background: linear-gradient(135deg, var(--primary-color), #34495e);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        header h1 { margin: 0; font-size: 1.5rem; font-weight: 700; }
        header small { display: block; margin-top: 5px; opacity: 0.9; font-size: 0.9rem; }

        .container { padding: 20px; max-width: 850px; margin: 0 auto; padding-bottom: 100px; }
        .card { background: var(--card-bg); border-radius: 16px; padding: 25px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.05); }

        /* æ‹–æ›³å€ */
        .drop-zone {
            border: 3px dashed #bdc3c7; border-radius: 12px; padding: 40px 20px; text-align: center;
            cursor: pointer; position: relative; background: #fcfcfc; transition: all 0.3s;
        }
        .drop-zone:hover, .drop-zone.dragover { background: #fef9e7; border-color: var(--accent-color); transform: scale(1.01); }
        .drop-zone input { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; }
        .icon-large { font-size: 48px; display: block; margin-bottom: 10px; }
        .paste-hint { display: inline-block; margin-top: 10px; padding: 5px 12px; background: #e8f6f3; color: #16a085; border-radius: 20px; font-size: 0.85rem; font-weight: 500; }

        /* é€²éšæ§åˆ¶å€ */
        .controls-area {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
        }
        .control-group {
            margin-bottom: 15px;
        }
        .control-label {
            font-weight: 700; color: var(--primary-color); display: flex; justify-content: space-between; margin-bottom: 5px;
        }
        .slider-container {
            display: flex; align-items: center; gap: 10px;
        }
        input[type="range"] {
            flex: 1; cursor: pointer;
        }
        .checkbox-group {
            display: flex; align-items: center; gap: 10px;
        }
        .checkbox-group input { width: 18px; height: 18px; }

        /* é è¦½èˆ‡æ–‡å­—æ¡† */
        #debug-preview { display: none; margin-top: 15px; text-align: center; background: #2c3e50; padding: 10px; border-radius: 8px; }
        #debug-preview img { height: 80px; border: 1px solid #fff; background: white; object-fit: contain; }
        .preview-title { color: #fff; font-size: 0.8rem; margin-bottom: 5px; display: block;}

        textarea {
            width: 100%; height: 100px; border: 2px solid #ecf0f1; border-radius: 10px; padding: 15px;
            font-size: 16px; margin-top: 20px; font-family: 'Monaco', monospace; box-sizing: border-box; background: #fafafa;
        }
        textarea:focus { outline: none; border-color: var(--accent-color); background: #fff; }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        button { padding: 12px 20px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        button:active { transform: scale(0.97); }
        .btn-action { background: var(--primary-color); color: white; }
        .btn-clear { background: #ecf0f1; color: #555; }

        /* å‹¤å‹™åŠŸèƒ½ */
        .duty-actions { display: none; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; padding-top: 20px; border-top: 2px dashed #eee; }
        @media (min-width: 500px) { .duty-actions { grid-template-columns: 1fr 1fr 1fr 1fr; } }
        .btn-gmap { background: #4285f4; color: white; }
        .btn-line { background: var(--line-green); color: white; }
        .btn-tg { background: var(--tg-color); color: white; }
        .btn-copy { background: var(--copy-color); color: white; }

        /* æ­·å²ç´€éŒ„ */
        .history-section { margin-top: 30px; }
        .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-left: 5px solid var(--accent-color); padding-left: 12px; }
        .history-title { font-size: 1.25rem; font-weight: 700; color: var(--primary-color); }
        .history-item { background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #eee; position: relative; }
        .history-coord { font-family: monospace; font-weight: 700; font-size: 1.1rem; color: var(--primary-color); }
        .history-time { font-size: 0.85rem; color: #95a5a6; }
        .history-actions { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
        .btn-sm { padding: 6px 12px; font-size: 0.9rem; border-radius: 5px; }
        .btn-del { background: transparent; color: #e74c3c; position: absolute; top: 10px; right: 10px; font-size: 0.9rem; padding: 5px; box-shadow: none; }

        #map { height: 400px; width: 100%; border-radius: 12px; margin-top: 20px; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        #status-bar { display: none; padding: 12px; background: #d4edda; color: #155724; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: 500; }

        /* è£åˆ‡ */
        #cropModal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); z-index: 10000; flex-direction: column; }
        .crop-hint { background: #f39c12; color: #fff; padding: 15px; text-align: center; font-weight: 500; position: absolute; top: 0; width: 100%; z-index: 10001; }
        .crop-container { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; padding: 60px 20px 90px 20px; }
        .crop-controls { height: 80px; background: #1e272e; display: flex; justify-content: center; gap: 20px; align-items: center; position: absolute; bottom: 0; width: 100%; z-index: 10001; }
        #imageToCrop { max-width: 100%; max-height: 100%; }
        .btn-confirm { background: var(--success-color); color: white; width: 150px; }
        .btn-cancel { background: #555; color: white; width: 100px; }
    </style>
</head>
<body>

<header>
    <h1>ğŸ‘®â€â™‚ï¸ è­¦å¯Ÿå°å¹«æ‰‹ v16</h1>
    <small>è£œå­—ä¿®å¾© | è‡ªå‹•è½‰é»‘ç™½ | æŠ—æ‘©çˆ¾ç´‹</small>
</header>

<div class="container">
    <div id="status-bar">ç³»çµ±æº–å‚™å°±ç·’</div>

    <div class="card">
        <div class="drop-zone" id="dropZone">
            <span class="icon-large">ğŸ“·</span>
            <div style="font-size:1.1rem; font-weight:500;">é»æ“Šã€æ‹–æ›³ï¼Œæˆ– Ctrl+V è²¼ä¸Š</div>
            <span class="paste-hint">ğŸ’¡ å°ˆé–€è™•ç†è¢å¹•ç¿»æ‹ã€å­—é«”ç ´ç¢</span>
            <input type="file" id="fileInput" accept="image/*" onchange="handleFileSelect(this)">
        </div>

        <!-- é€²éšå½±åƒæ§åˆ¶ -->
        <div class="controls-area">
            <div class="control-group">
                <div class="control-label">
                    <span>ğŸ”§ è£œå­—å¼·åº¦ (é€£é€šæ–·è£‚ç­†ç•«)</span>
                    <span id="thickVal" style="color:var(--accent-color)">2</span>
                </div>
                <div class="slider-container">
                    <input type="range" id="thickenRange" min="0" max="5" step="1" value="2" oninput="updatePreview()">
                </div>
                <div style="font-size:0.8rem; color:#666; margin-top:5px;">
                    æ•¸å­—è¶Šç¢ï¼Œå¼·åº¦èª¿è¶Šé«˜ã€‚èª¿å¤ªé«˜å¯èƒ½æœƒç³Šåœ¨ä¸€èµ·ã€‚
                </div>
            </div>
            
            <div class="checkbox-group">
                <input type="checkbox" id="autoInvert" checked onchange="updatePreview()">
                <label for="autoInvert" style="font-weight:500;">è‡ªå‹•è½‰ç‚ºã€Œç™½åº•é»‘å­—ã€ (æ¨è–¦é–‹å•Ÿ)</label>
            </div>
        </div>

        <div id="debug-preview">
            <span class="preview-title">â–¼ æ©Ÿå™¨å°‡è®€å–é€™å¼µã€Œä¿®å¾©å¾Œã€çš„å½±åƒ</span>
            <img id="processedImg" src="" />
        </div>
        
        <textarea id="inputText" placeholder="OCR è¾¨è­˜çµæœ..."></textarea>
        
        <div class="btn-group">
            <button class="btn-clear" onclick="resetAll()">ğŸ”„ æ¸…ç©º</button>
            <button class="btn-action" onclick="runOCRFromPreview()">ğŸ” é–‹å§‹è§£æ</button>
        </div>

        <div class="duty-actions" id="dutyActions">
            <button class="btn-gmap" onclick="openGoogleMaps()">ğŸŒ åœ°åœ–</button>
            <button class="btn-copy" id="btnCopy" onclick="copyToClipboard()">ğŸ“‹ è¤‡è£½</button>
            <button class="btn-tg" onclick="shareToTelegram()">âœˆï¸ TG</button>
            <button class="btn-line" onclick="shareToLine()">ğŸ’¬ LINE</button>
        </div>
    </div>

    <div id="map"></div>

    <div class="history-section">
        <div class="history-header">
            <div class="history-title">ğŸ“ æ­·å²ç´€éŒ„</div>
            <button class="btn-sm btn-clear" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…é™¤</button>
        </div>
        <ul class="history-list" id="historyList"></ul>
    </div>
</div>

<div id="cropModal">
    <div class="crop-hint">ğŸ’¡ è¨£ç«…ï¼šè«‹ç›¡é‡ã€Œåªæ¡†é¸æ•¸å­—ã€ï¼Œé¿é–‹ä¸­æ–‡èˆ‡é›œè¨Šï¼</div>
    <div class="crop-container">
        <img id="imageToCrop" src="" alt="Source Image">
    </div>
    <div class="crop-controls">
        <button class="btn-cancel" onclick="closeCropModal()">å–æ¶ˆ</button>
        <button class="btn-confirm" onclick="confirmCrop()">âœ‚ï¸ ç¢ºèªè£åˆ‡</button>
    </div>
</div>

<script>
    let map, marker, sectorLayer;
    let cropper;
    let currentLat = null, currentLng = null;
    let currentCellInfo = "";
    let historyData = [];
    let currentCanvas = null; // æš«å­˜è£åˆ‡å¾Œçš„åŸå§‹ canvas

    window.onload = () => loadHistory();

    // --- æª”æ¡ˆè™•ç† ---
    const dropZone = document.getElementById('dropZone');
    window.addEventListener('paste', e => {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) { processFile(items[i].getAsFile()); e.preventDefault(); break; }
        }
    });
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); }, false));
    ['dragenter', 'dragover'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.add('dragover'), false));
    ['dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, () => dropZone.classList.remove('dragover'), false));
    dropZone.addEventListener('drop', e => { if (e.dataTransfer.files.length) processFile(e.dataTransfer.files[0]); }, false);
    function handleFileSelect(input) { if (input.files.length) processFile(input.files[0]); input.value = ''; }
    function processFile(file) {
        const reader = new FileReader();
        reader.onload = (e) => openCropModal(e.target.result);
        reader.readAsDataURL(file);
    }

    // --- è£åˆ‡ ---
    function openCropModal(src) {
        const modal = document.getElementById('cropModal');
        const img = document.getElementById('imageToCrop');
        img.src = src;
        modal.style.display = 'flex';
        if (cropper) cropper.destroy();
        setTimeout(() => {
            cropper = new Cropper(img, {
                viewMode: 1, dragMode: 'move', autoCropArea: 0.6,
                restore: false, guides: true, center: true, highlight: false,
                cropBoxMovable: true, cropBoxResizable: true, toggleDragModeOnDblclick: false,
            });
        }, 100);
    }
    function closeCropModal() { document.getElementById('cropModal').style.display = 'none'; if (cropper) cropper.destroy(); }
    
    function confirmCrop() {
        if (!cropper) return;
        currentCanvas = cropper.getCroppedCanvas();
        closeCropModal();
        
        // çµ±ä¸€å°ºå¯¸
        if (currentCanvas.width < 800) {
            const scale = 800 / currentCanvas.width;
            const newC = document.createElement('canvas');
            newC.width = 800; newC.height = currentCanvas.height * scale;
            const ctx = newC.getContext('2d');
            ctx.imageSmoothingEnabled = true; ctx.imageSmoothingQuality = 'high';
            ctx.drawImage(currentCanvas, 0, 0, newC.width, newC.height);
            currentCanvas = newC;
        }

        updatePreview(); // ç«‹å³åŸ·è¡Œä¸€æ¬¡é è¦½
    }

    // --- å³æ™‚é è¦½èˆ‡å½±åƒè™•ç† ---
    function updatePreview() {
        if (!currentCanvas) return;
        document.getElementById('thickVal').innerText = document.getElementById('thickenRange').value;
        
        // è¤‡è£½ä¸€ä»½ canvas ä¾†è™•ç†ï¼Œä¸å½±éŸ¿åŸå§‹æª”
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = currentCanvas.width;
        tempCanvas.height = currentCanvas.height;
        const ctx = tempCanvas.getContext('2d');
        ctx.drawImage(currentCanvas, 0, 0);

        const thickness = parseInt(document.getElementById('thickenRange').value);
        const autoInvert = document.getElementById('autoInvert').checked;

        preprocessImage(tempCanvas, thickness, autoInvert);
        
        document.getElementById('debug-preview').style.display = 'block';
        document.getElementById('processedImg').src = tempCanvas.toDataURL();
    }

    // æ ¸å¿ƒå½±åƒè™•ç† (v16 å‡ç´šç‰ˆ)
    function preprocessImage(canvas, thickness, autoInvert) {
        const ctx = canvas.getContext('2d');
        let idata = ctx.getImageData(0, 0, canvas.width, canvas.height);
        let d = idata.data;
        
        // 1. ç°éšåŒ–èˆ‡äº®åº¦è¨ˆç®—
        let totalBrightness = 0;
        for (let i = 0; i < d.length; i += 4) {
            const avg = (0.299 * d[i] + 0.587 * d[i+1] + 0.114 * d[i+2]);
            d[i] = d[i+1] = d[i+2] = avg;
            totalBrightness += avg;
        }
        
        // 2. æ™ºæ…§åç›¸ (å¦‚æœæ˜¯é»‘åº•ç™½å­—ï¼Œè½‰æˆç™½åº•é»‘å­—)
        // è¨ˆç®—å¹³å‡äº®åº¦ (0-255)
        const avgBrightness = totalBrightness / (d.length / 4);
        let isInverted = false;
        
        if (autoInvert && avgBrightness < 100) { // ç•«é¢åæš—ï¼Œæ¥µå¯èƒ½æ˜¯é»‘åº•ç™½å­—
            for (let i = 0; i < d.length; i += 4) {
                d[i] = 255 - d[i];
                d[i+1] = 255 - d[i+1];
                d[i+2] = 255 - d[i+2];
            }
            isInverted = true;
        }

        // 3. äºŒå€¼åŒ– (è®“èƒŒæ™¯å…¨ç™½ï¼Œæ–‡å­—å…¨é»‘)
        // ä½¿ç”¨ç°¡å–®é–¾å€¼ï¼Œä½†ç‚ºäº†ä¿ç•™æ–‡å­—ç´°ç¯€ï¼Œä¸å®œåˆ‡å¤ªæ­»
        const threshold = 180; 
        for (let i = 0; i < d.length; i += 4) {
            // å¦‚æœæ˜¯ç™½åº•é»‘å­—ï¼Œæ–‡å­—æ‡‰è©²æ˜¯æš—çš„
            const v = d[i] < threshold ? 0 : 255;
            d[i] = d[i+1] = d[i+2] = v;
        }
        
        ctx.putImageData(idata, 0, 0);

        // 4. å½¢æ…‹å­¸è†¨è„¹ (è£œæ–·å­—) - é—œéµæ­¥é©Ÿ
        // å› ç‚ºç¾åœ¨æ˜¯ç™½åº•é»‘å­—(0)ï¼Œæˆ‘å€‘è¦ã€Œè…è•ã€ç™½è‰²èƒŒæ™¯ï¼Œç­‰æ–¼ã€Œè†¨è„¹ã€é»‘è‰²æ–‡å­—
        if (thickness > 0) {
            performErosion(canvas, thickness); // å°é»‘è‰²å€åŸŸé€²è¡Œæ“´å¼µ
        }
    }

    // ç°¡å–®çš„è…è•æ¼”ç®—æ³• (æœ€å°å€¼æ¿¾æ³¢) -> ç”¨æ–¼åŠ ç²—é»‘è‰²æ–‡å­—
    function performErosion(canvas, radius) {
        if (radius === 0) return;
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        const srcData = ctx.getImageData(0, 0, w, h);
        const dstData = ctx.createImageData(w, h);
        const src = srcData.data;
        const dst = dstData.data;

        // åªåšæ°´å¹³èˆ‡å‚ç›´æ–¹å‘çš„æ“´å¼µï¼Œæ•ˆç‡è¼ƒé«˜ä¸”é©åˆæ•¸å­—
        for (let y = 0; y < h; y++) {
            for (let x = 0; x < w; x++) {
                let minVal = 255;
                
                // æœå°‹å‘¨åœé„°å±…
                for (let ky = -radius; ky <= radius; ky++) {
                    for (let kx = -radius; kx <= radius; kx++) {
                        const ny = y + ky;
                        const nx = x + kx;
                        if (ny >= 0 && ny < h && nx >= 0 && nx < w) {
                            const idx = (ny * w + nx) * 4;
                            // å–ç´…è‰²é€šé“å³å¯(å› ç‚ºå·²æ˜¯ç°éš)
                            const val = src[idx]; 
                            if (val < minVal) minVal = val;
                        }
                    }
                }
                
                const dstIdx = (y * w + x) * 4;
                dst[dstIdx] = dst[dstIdx+1] = dst[dstIdx+2] = minVal;
                dst[dstIdx+3] = 255;
            }
        }
        ctx.putImageData(dstData, 0, 0);
    }

    // --- åŸ·è¡Œ OCR (å¾é è¦½åœ–) ---
    function runOCRFromPreview() {
        const img = document.getElementById('processedImg');
        if (!img.src || img.src === window.location.href) {
            alert("è«‹å…ˆé¸æ“‡åœ–ç‰‡ä¸¦è£åˆ‡ï¼");
            return;
        }

        const bar = document.getElementById('status-bar');
        bar.style.display = 'block'; bar.innerText = 'â³ æ­£åœ¨è¾¨è­˜ä¸­...';
        bar.style.background = '#d6eaf8'; bar.style.color = '#2980b9';
        
        Tesseract.recognize(img.src, 'eng+chi_tra').then(({ data: { text } }) => {
            bar.innerText = 'âœ… è¾¨è­˜å®Œæˆï¼Œè§£æä¸­...';
            bar.style.background = '#d4edda'; bar.style.color = '#155724';
            let clean = text.replace(/O/g, '0').replace(/o/g, '0').replace(/l/g, '1').replace(/I/g, '1').replace(/S/g, '5').replace(/B/g, '8').replace(/\|/g, '1');
            document.getElementById('inputText').value = clean;
            parseText();
        }).catch(err => {
            bar.innerText = 'âŒ è¾¨è­˜å¤±æ•—'; bar.style.background = '#f8d7da'; bar.style.color = '#721c24';
        });
    }

    // --- è§£æèˆ‡å…¶ä»–åŠŸèƒ½ (ä¿æŒ v15) ---
    function parseText() {
        const text = document.getElementById('inputText').value;
        const bar = document.getElementById('status-bar');
        currentLat = null; currentLng = null; currentCellInfo = "";

        const tokens = text.match(/[0-9]+(?:\.[0-9]+)?/g);
        let latList = [], lngList = [];

        if (tokens) {
            for (let i = 0; i < tokens.length; i++) {
                checkCandidate(tokens[i], latList, lngList);
                if (i < tokens.length - 1) checkCandidate(tokens[i] + "." + tokens[i+1], latList, lngList);
            }
        }

        if (latList.length) currentLat = latList.sort((a,b) => b.toString().length - a.toString().length)[0];
        if (lngList.length) currentLng = lngList.sort((a,b) => b.toString().length - a.toString().length)[0];

        const dirM = text.match(/(?:æ–¹å‘è§’|Dir|AntennaDir|Azimuth)[^0-9\n]*([0-9]+(?:\.[0-9]+)?)/i);
        const cellM = text.match(/(?:CellID|CID|åŸºç«™|ç·¨è™Ÿ)[^0-9\n]*([0-9]+)/i);
        let dir = dirM ? parseFloat(dirM[1]) : null;
        let cellId = cellM ? cellM[1] : null;

        if(cellId) currentCellInfo += `åŸºç«™:${cellId} `;
        if(dir !== null) currentCellInfo += `æ–¹å‘:${dir}Â° `;

        if (currentLat && currentLng) {
            bar.innerText = `âœ… å®šä½æˆåŠŸ: ${currentLat}, ${currentLng}`;
            bar.style.background = '#d4edda'; bar.style.color = '#155724';
            showMap(currentLat, currentLng, dir, cellId);
            document.getElementById('dutyActions').style.display = 'grid';
            addToHistory(currentLat, currentLng, cellId, dir);
        } else {
            bar.innerText = 'âš ï¸ è§£æå¤±æ•—ï¼Œè«‹èª¿æ•´ã€Œè£œå­—å¼·åº¦ã€å¾Œé‡è©¦';
            bar.style.background = '#fff3cd'; bar.style.color = '#856404';
        }
    }

    function checkCandidate(str, latList, lngList) {
        let raw = parseFloat(str.replace(/\./g, ""));
        if (isNaN(raw)) return;
        let lat = tryFit(raw, 21, 27);
        if (!lat && parseFloat(str) >= 21 && parseFloat(str) <= 27) lat = parseFloat(str);
        if (lat) latList.push(lat);
        let lng = tryFit(raw, 118, 124);
        if (!lng && parseFloat(str) >= 118 && parseFloat(str) <= 124) lng = parseFloat(str);
        if (lng) lngList.push(lng);
    }

    function tryFit(num, min, max) {
        let t = num;
        if (t >= min && t <= max) return t;
        while (t > max) t /= 10;
        if (t >= min) return t;
        return null;
    }

    function showMap(lat, lng, dir, cellId) {
        const mapDiv = document.getElementById('map');
        mapDiv.style.display = 'block';
        if (!map) {
            map = L.map('map').setView([lat, lng], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OSM' }).addTo(map);
        } else {
            map.setView([lat, lng], 16);
            map.invalidateSize();
        }
        if (marker) map.removeLayer(marker);
        if (sectorLayer) map.removeLayer(sectorLayer);

        let popMsg = `<b>ğŸ¯ å®šä½é»</b><br>Lat: ${lat}<br>Lng: ${lng}`;
        if (cellId) popMsg += `<br>CID: ${cellId}`;
        marker = L.marker([lat, lng]).addTo(map).bindPopup(popMsg).openPopup();

        if (dir !== null) drawSector(lat, lng, dir);
        else sectorLayer = L.circle([lat, lng], { radius: 300, color: '#3498db', fillOpacity: 0.2 }).addTo(map);
        mapDiv.scrollIntoView({ behavior: 'smooth' });
    }

    function drawSector(lat, lng, angle) {
        const r = 500; const spread = 60;
        const start = (90 - (angle - spread/2)) * (Math.PI/180);
        const end = (90 - (angle + spread/2)) * (Math.PI/180);
        let pts = [[lat, lng]];
        for(let i=0; i<=15; i++) {
            let a = start - (i/15)*(start-end);
            let dLat = (r/111000) * Math.sin(a);
            let dLng = (r/(111000*Math.cos(lat*Math.PI/180))) * Math.cos(a);
            pts.push([lat+dLat, lng+dLng]);
        }
        pts.push([lat, lng]);
        sectorLayer = L.polygon(pts, { color:'red', fillColor:'#e74c3c', fillOpacity:0.4, weight:1 }).addTo(map);
    }

    function openGoogleMaps() { if (currentLat && currentLng) window.open(`https://www.google.com/maps/search/?api=1&query=${currentLat},${currentLng}`, '_blank'); }
    function shareToLine() {
        if (!currentLat || !currentLng) return;
        const mapUrl = `https://www.google.com/maps/search/?api=1&query=${currentLat},${currentLng}`;
        let text = `ğŸš¨ [è­¦ç”¨å®šä½é€šå ±]\nåº§æ¨™: ${currentLat}, ${currentLng}\n${currentCellInfo}\nåœ°åœ–: ${mapUrl}`;
        window.open(`https://line.me/R/msg/text/?${encodeURIComponent(text)}`, '_blank');
    }
    function shareToTelegram() {
        if (!currentLat || !currentLng) return;
        const mapUrl = `https://www.google.com/maps/search/?api=1&query=${currentLat},${currentLng}`;
        let text = `ğŸš¨ [è­¦ç”¨å®šä½é€šå ±]\nåº§æ¨™: ${currentLat}, ${currentLng}\n${currentCellInfo}`;
        window.open(`https://t.me/share/url?url=${encodeURIComponent(mapUrl)}&text=${encodeURIComponent(text)}`, '_blank');
    }
    function copyToClipboard() {
        if (!currentLat || !currentLng) return;
        const mapUrl = `https://www.google.com/maps/search/?api=1&query=${currentLat},${currentLng}`;
        const fullText = `ã€å®šä½é€šå ±ã€‘\næ™‚é–“: ${new Date().toLocaleString('zh-TW',{hour12:false})}\nåº§æ¨™: ${currentLat}, ${currentLng}\n${currentCellInfo}\nåœ°åœ–: ${mapUrl}`;
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(fullText).then(() => showCopySuccess());
        } else {
            const ta = document.createElement("textarea"); ta.value = fullText; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta); showCopySuccess();
        }
    }
    function showCopySuccess() {
        const btn = document.getElementById('btnCopy'); const old = btn.innerHTML;
        btn.innerHTML = 'âœ… å·²è¤‡è£½ï¼'; btn.style.background = '#27ae60';
        setTimeout(() => { btn.innerHTML = old; btn.style.background = ''; }, 1500);
    }

    function loadHistory() {
        const stored = localStorage.getItem('police_locate_history');
        if (stored) historyData = JSON.parse(stored);
        renderHistory();
    }
    function addToHistory(lat, lng, cid, dir) {
        if (historyData.length > 0 && historyData[0].lat === lat && historyData[0].lng === lng) return;
        const item = { id: Date.now(), time: new Date().toLocaleString('zh-TW',{hour12:false}), lat, lng, cellId: cid||'ç„¡', dir: dir||'ç„¡' };
        historyData.unshift(item); if (historyData.length > 50) historyData.pop();
        localStorage.setItem('police_locate_history', JSON.stringify(historyData));
        renderHistory();
    }
    function renderHistory() {
        const list = document.getElementById('historyList'); list.innerHTML = '';
        if (!historyData.length) { list.innerHTML = '<li style="text-align:center;padding:20px;color:#aaa;">ç„¡ç´€éŒ„</li>'; return; }
        historyData.forEach(item => {
            const li = document.createElement('li'); li.className = 'history-item';
            li.innerHTML = `<button class="btn-del" onclick="deleteHistory(${item.id})">âœ•</button><div class="history-time">${item.time}</div><div class="history-coord">${item.lat}, ${item.lng}</div><div style="font-size:0.9rem;color:#777;">CID: ${item.cellId} | Dir: ${item.dir}Â°</div><div class="history-actions"><button class="btn-sm btn-gmap" onclick="openHistoryMap(${item.lat}, ${item.lng})">åœ°åœ–</button></div>`; 
            list.appendChild(li);
        });
    }
    function deleteHistory(id) { historyData = historyData.filter(i => i.id !== id); localStorage.setItem('police_locate_history', JSON.stringify(historyData)); renderHistory(); }
    function clearHistory() { if(confirm("æ¸…ç©ºç´€éŒ„?")) { historyData = []; localStorage.removeItem('police_locate_history'); renderHistory(); } }
    function openHistoryMap(lat, lng) { window.open(`https://www.google.com/maps/search/?api=1&query=${lat},${lng}`, '_blank'); }
    function resetAll() {
        document.getElementById('inputText').value = ''; document.getElementById('debug-preview').style.display = 'none';
        document.getElementById('dutyActions').style.display = 'none'; document.getElementById('fileInput').value = '';
        document.getElementById('status-bar').style.display = 'none'; if(marker) map.removeLayer(marker); if(sectorLayer) map.removeLayer(sectorLayer); document.getElementById('map').style.display = 'none'; window.scrollTo({top:0, behavior:'smooth'});
        currentCanvas = null;
    }
</script>

</body>
</html>